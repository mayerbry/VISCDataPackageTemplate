---
title: Uberla 465 NAb Processing
shorttitle: Uberla 465 NAb
from:
- name: Paul Obrecht
  email: pobrecht@fredhutch.org
includesummary: yes
summary: NAb processing for the Nussenzweig 465 study
vignette: >
  %\VignetteIndexEntry{Uberla 465 NAb Processing}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

<!--
Program Name: preprocess_nab.Rmd
Creation Date: 9/28/2017
Full name of author: Paul Obrecht
Project or Protocol: Uberla 465
Purpose or description of program: NAb data processing
Location of program: git@github.fhcrc.org:VIDD-VISC/Uberla465.git
Location of input data: git@github.fhcrc.org:VIDD-VISC/Uberla465.git
-->

This report documents the Uberla 465 NAb data processing.

# Preliminaries
We first source our external functions and global variables, load libraries, and set options.

```{r 'prelim', echo=TRUE, eval=TRUE}
# Get protocol name
pkgName <- roxygen2:::read.description("../DESCRIPTION")$Package

# Libraries
suppressPackageStartupMessages({
  library(knitr)
  library(data.table)
  library(xtable)
  library(readxl)
  library(ggplot2)
  library(kableExtra)}
)

# Functions, etc.
sys.source(rmarkdown:::normalize_path("./functions.R"), envir=topenv())
sys.source(rmarkdown:::normalize_path("./qc_functions.R"), envir=topenv())
sys.source(rmarkdown:::normalize_path("./protocol_specific.R"), envir=topenv())
```

# Processing
Next we read in the qdata. The only time point in the qdata file is visitno 30, which appears to be week 30.

```{r 'read_data'}
nab <- rbindlist(lapply(nab_qfilenames,
                        function(x){fread(file.path("..", "inst", "extdata", x))[, sourcefile := x]}),
                 use.names=TRUE, fill=TRUE)
setnames(nab, names(nab), tolower(names(nab)))

# add Week
nab[, Week := visitno]
```

```{r 'rx', eval=runrx, echo=runrx}
# merge group info
cat("# Treatment Assignment\nTreatment assignment information is merged in.\n")
# merge in treatment info
rx <- fread("../inst/extdata/rx.csv")
setkey(rx, ptid)
setkey(nab, ptid)
nab <- merge(nab, rx, all.x=TRUE)
kableit(setkey(nab[, .N, .(group)], group), caption = "Record count by group")
kableit(setkey(nab[, .N, .(ptid, group)], group, ptid), caption = "Record count by group and ptid")
```

```{r 'tier'}
# merge tier/clade
cat("# Tier/Clade\nTier and clade information is merged in.\n")
setkey(nab, isolate)
nab <- merge(nab, tier, all.x=TRUE)
kableit(setkey(nab[, .N, .(isolate, tier, clade)], isolate), caption = "Record count by isolate")
```


# Response call
```{r 'response_call'}
nab[method=="Dilution", titer_mod := nabTiter(titer, "dilution")]
nab[method=="Concentration", titer_mod := nabTiter(titer, "Concentration")]
nab[, response := nabResponse(titer)]

formula <- as.formula(paste(paste(setdiff(names(nab), c("titer", "titer_mod", "response", "poscrit")), collapse = " + "), "~ poscrit"))
nab <- dcast(nab, formula, value.var = c("titer", "titer_mod", "response"))
setkey(nab, celltype, isolate, ptid, visitno)
```

Some summaries of the unaveraged data follow.

## Analytes and Cell Types
```{r}
kableit(nab[, .N, .(isolate, celltype)])
```

## Time points represented in the data, with record count
```{r}
kableit(nab[, .N, Week])
```

## Range of Titer Values
```{r}
kableit(data.table(Statistic = names(summary(nab$titer_mod_50)), Value=as.numeric(summary(nab$titer_mod_50))), caption = "Summary of 50% positive criteria titers")
kableit(data.table(Statistic = names(summary(nab$titer_mod_80)), Value=as.numeric(summary(nab$titer_mod_80))), caption = "Summary of 80% positive criteria titers")
```

## Relationship of titer_mod_50 to titer_mod_80
```{r}
ggplot(nab, aes(x = titer_mod_50, y = titer_mod_80)) +
  geom_point(na.rm=TRUE, show.legend=TRUE)
```

# CDS variables
```{r}
nab[, cds_prot              := "cvd465"]
nab[, cds_sub_prot          := NA]
nab[, cds_subject_id        := paste(cds_prot, ptid, sep = ' ')]
nab[, cds_specimen_type     := 'serum']
nab[, cds_vaccine_matched   := 0]
nab[, cds_response_id50_std := response_50]
nab[, cds_response_id80_std := response_80]
nab[, cds_slope             := log(4)/(log(titer_mod_80)-log(titer_mod_50))]
nab[, cds_lab_code          := ifelse(labid == "MS", "Seaman",
                                      ifelse(labid %in% c("DM","DU"), "Montefiori", labid))]
```

# Output
```{r 'output'}
# separate serum into direct binding dilution and titration dilutions
setkey(nab, ptid, Week)
saveObj(inobj = "nab", suffix = "nab")
```
## Reproducibility Tables

```{r echo=FALSE, eval=TRUE}
path <- rmarkdown:::normalize_path("./reproducibility.R")
read_chunk(path)
```

```{r repro, echo=FALSE, eval=TRUE}
<<reprotab>>
```

```{r copySourcedFiles, eval = grepl("data-raw", getwd()), echo = FALSE}
# copy sourced files and external R chunks to inst/doc/ and to vignettes/ to avoid errors on installing
# myArgs1 <- paste("preprocess_bama.Rmd", "| grep 'sys.source(' | grep -v 'grep'")
# myArgs2 <- paste("preprocess_bama.Rmd", "| grep 'read_chunk(' | grep -v 'grep'")
myArgs1 <- paste(knitr::current_input(), "| grep 'sys.source(' | grep -v 'grep'")
myArgs2 <- paste(knitr::current_input(), "| grep 'read_chunk(' | grep -v 'grep'")
filesToCopy1 <- sapply(strsplit(system2("cat", args = myArgs1, stdout=TRUE), split = '"'), function(x) x[2])
filesToCopy2 <- sapply(strsplit(system2("cat", args = myArgs2, stdout=TRUE), split = '"'), function(x) x[2])
system2(command = "cp", args = paste(c("-f", filesToCopy1, filesToCopy2, "../inst/doc/"), collapse=" "))
system2(command = "cp", args = paste(c("-f", filesToCopy1, filesToCopy2, "../vignettes"), collapse=" "))
```

